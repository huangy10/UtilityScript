#!/usr/local/bin/python
import os
import chardet
import argparse

parser = argparse.ArgumentParser(description="Convert encoding of subtitle files")
parser.add_argument("filename", type=str, help="input file")

def convert_file(file_name):
    with open(file_name, 'r+') as f:
        data = f.read()
        encodings = chardet.detect(data)
        if encodings["encoding"] == "utf-8":
            print("File already encoded in utf-8")
            exit
        try:
            data = data.decode(encodings["encoding"]).encode("utf-8")
        except UnicodeDecodeError:
            data = data.decode("GBK").encode("utf-8")
        f.seek(0)
        f.write(data)
        f.truncate()

if __name__ == "__main__":
    args = parser.parse_args()
    filename = args.filename
    if os.path.isfile(filename):
        convert_file(filename)
    else:
        subtitle_files = [f for f in os.listdir(filename) if os.path.isfile(f) and f.endswith(".srt")]
        for f in subtitle_files:
            print("converting %s" % f)
            convert_file(f)

